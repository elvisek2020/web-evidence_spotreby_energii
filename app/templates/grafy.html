{% extends "base.html" %}

{% block title %}{{ app_title }} - Grafy{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
    <!-- Loading skeleton -->
    <div id="loading-skeleton" class="hidden">
        <div class="animate-pulse">
            <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded-lg mb-4"></div>
            <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded-lg mb-4"></div>
            <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded-lg"></div>
        </div>
    </div>
    
    <!-- Kontrolky pro zapínání/vypínání grafů -->
    <div class="mb-6">
        <div class="flex flex-wrap gap-4 justify-center mb-4">
            <label class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors">
                <input type="checkbox" id="toggle-elektromer_vysoky" checked class="mr-2" onchange="toggleDataset('elektromer_vysoky')">
                <span class="text-sm font-medium">Elektroměr vysoký tarif</span>
            </label>
            <label class="inline-flex items-center px-4 py-2 bg-red-100 text-red-800 rounded-lg cursor-pointer hover:bg-red-200 transition-colors">
                <input type="checkbox" id="toggle-elektromer_nizky" checked class="mr-2" onchange="toggleDataset('elektromer_nizky')">
                <span class="text-sm font-medium">Elektroměr nízký tarif</span>
            </label>
            <label class="inline-flex items-center px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg cursor-pointer hover:bg-yellow-200 transition-colors">
                <input type="checkbox" id="toggle-plynomer" checked class="mr-2" onchange="toggleDataset('plynomer')">
                <span class="text-sm font-medium">Plynoměr</span>
            </label>
            <label class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg cursor-pointer hover:bg-green-200 transition-colors">
                <input type="checkbox" id="toggle-vodomer" checked class="mr-2" onchange="toggleDataset('vodomer')">
                <span class="text-sm font-medium">Vodoměr</span>
            </label>
        </div>
    </div>
    
    <!-- Hlavní graf -->
    <div id="charts-container">
        <div class="mb-6">
            <canvas id="main-chart" style="height: 500px; width: 100%;"></canvas>
        </div>
    </div>
    
    <!-- Tlačítka pro přepínání typu grafu a časového období -->
    <div class="flex flex-wrap justify-between items-center gap-4">
        <!-- Levé tlačítka -->
        <div class="flex flex-wrap gap-4">
            <button onclick="toggleChartType()" class="inline-flex items-center px-4 py-2 bg-white text-blue-700 font-medium rounded-lg hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-300 transition-colors border border-blue-200 shadow-sm" id="chart-type-btn">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span id="chart-type-text">Čárový graf</span>
            </button>
            <button onclick="toggleAllDatasets()" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-300 transition-colors border border-gray-200 shadow-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
                <span id="toggle-all-text">Vypnout vše</span>
            </button>
        </div>
        
        <!-- Pravé tlačítka -->
        <div class="flex flex-wrap gap-4">
            <button onclick="changePeriod('year')" id="period-year" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-300 transition-colors">
                Poslední rok
            </button>
            <button onclick="changePeriod('2years')" id="period-2years" class="inline-flex items-center px-4 py-2 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-300 transition-colors border border-gray-300">
                Dva roky
            </button>
            <button onclick="changePeriod('all')" id="period-all" class="inline-flex items-center px-4 py-2 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-300 transition-colors border border-gray-300">
                Všechno
            </button>
        </div>
    </div>
</section>

<!-- Meziroční porovnání -->
<section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 text-center">Meziroční porovnání spotřeby</h3>
    <div id="yoy-container">
        <div class="animate-pulse flex justify-center py-8">
            <div class="h-6 w-48 bg-gray-200 dark:bg-gray-700 rounded"></div>
        </div>
    </div>
</section>

<!-- Nápověda -->
<section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 text-center">Nápověda</h3>
    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        <p>• Grafy zobrazují kumulativní hodnoty měřičů (celkové stavy)</p>
        <p>• Můžete zapínat/vypínat jednotlivé typy měřičů pomocí zaškrtávacích políček</p>
        <p>• Přepínání mezi čárovým a sloupcovým grafem pomocí tlačítka vlevo dole</p>
        <p>• Filtrování podle časového období pomocí tlačítek vpravo dole</p>
        <p>• Meziroční porovnání ukazuje rozdíl spotřeby oproti předchozímu roku</p>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
let chartType = 'line'; // 'bar' nebo 'line'
let mainChart = null; // Hlavní graf
let chartData = null; // Uložení dat
let currentPeriod = 'year'; // Aktuální časové období
let datasetVisibility = {
    'elektromer_vysoky': true,
    'elektromer_nizky': true,
    'plynomer': true,
    'vodomer': true
};

let chartWaitAttempts = 0;
const maxChartWaitAttempts = 50;

function waitForChart() {
    if (typeof Chart !== 'undefined') {
        loadChartData();
    } else {
        chartWaitAttempts++;
        if (chartWaitAttempts < maxChartWaitAttempts) {
            setTimeout(waitForChart, 100);
        } else {
            document.getElementById('charts-container').innerHTML = `
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Chyba při načítání knihovny</h3>
                    <p class="text-gray-600">Chart.js se nepodařilo načíst. Zkuste obnovit stránku.</p>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Obnovit stránku
                    </button>
                </div>
            `;
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    waitForChart();
    loadYoYData();
});

window.addEventListener('darkmodechange', function() {
    if (mainChart && chartData) createMainChart();
});

async function loadChartData() {
    const loadingSkeleton = document.getElementById('loading-skeleton');
    const chartsContainer = document.getElementById('charts-container');
    
    loadingSkeleton.classList.remove('hidden');
    chartsContainer.classList.add('hidden');
    
    try {
        const response = await fetch(`/api/grafy/data?period=${encodeURIComponent(currentPeriod)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        chartData = await response.json();
        
        loadingSkeleton.classList.add('hidden');
        chartsContainer.classList.remove('hidden');
        
        if (chartData.labels.length === 0) {
            showNoDataMessage();
            return;
        }
        
        createMainChart();
        
    } catch (error) {
        console.error('Chyba při načítání dat grafů:', error);
        loadingSkeleton.classList.add('hidden');
        chartsContainer.classList.remove('hidden');
        
        // Zobrazení chybové zprávy
        chartsContainer.innerHTML = `
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Chyba při načítání dat</h3>
                <p class="text-gray-600">Nepodařilo se načíst data pro grafy. Zkuste obnovit stránku.</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Obnovit stránku
                </button>
            </div>
        `;
    }
}

const datasetKeys = ['elektromer_vysoky', 'elektromer_nizky', 'plynomer', 'vodomer'];
const datasetLabels = {
    'elektromer_vysoky': 'Elektroměr vysoký tarif (kWh)',
    'elektromer_nizky': 'Elektroměr nízký tarif (kWh)',
    'plynomer': 'Plynoměr (m³)',
    'vodomer': 'Vodoměr (m³)'
};
const datasetColors = {
    'elektromer_vysoky': '#3B82F6',
    'elektromer_nizky': '#EF4444',
    'plynomer': '#F59E0B',
    'vodomer': '#10B981'
};

function isDark() {
    return document.documentElement.classList.contains('dark');
}

function createMainChart() {
    try {
        if (typeof Chart === 'undefined' || !chartData || !chartData.labels || chartData.labels.length === 0) return;
        
        const ctx = document.getElementById('main-chart').getContext('2d');
        if (mainChart) mainChart.destroy();
        
        const dark = isDark();
        const textColor = dark ? '#e5e7eb' : '#374151';
        const gridColor = dark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        
        const datasets = datasetKeys.map((key, idx) => {
            const color = datasetColors[key];
            return {
                label: datasetLabels[key],
                data: (chartData[key] || []).map(v => v !== null ? v : undefined),
                backgroundColor: color + '80',
                borderColor: color,
                borderWidth: 2,
                pointBackgroundColor: color,
                pointBorderColor: dark ? '#1f2937' : '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.1,
                spanGaps: false,
                hidden: !datasetVisibility[key]
            };
        });
        
        mainChart = new Chart(ctx, {
            type: chartType,
            data: { labels: chartData.labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true, text: 'Spotřeba energií',
                        font: { size: 18, weight: 'bold' },
                        color: textColor,
                        padding: { top: 10, bottom: 20 }
                    },
                    legend: {
                        display: true, position: 'top',
                        labels: { usePointStyle: true, padding: 20, font: { size: 12 }, color: textColor }
                    },
                    tooltip: {
                        mode: 'index', intersect: false,
                        backgroundColor: dark ? 'rgba(30,41,59,0.95)' : 'rgba(0,0,0,0.8)',
                        borderColor: dark ? '#475569' : '#ddd', borderWidth: 1, cornerRadius: 6,
                        callbacks: {
                            label: function(ctx) {
                                const v = ctx.parsed.y;
                                return ctx.dataset.label + ': ' + (v !== null ? v.toFixed(2) : 'N/A');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Datum', font: { size: 12, weight: 'bold' }, color: textColor },
                        ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 }, color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        title: { display: true, text: 'Spotřeba', font: { size: 12, weight: 'bold' }, color: textColor },
                        ticks: { font: { size: 10 }, color: textColor },
                        grid: { color: gridColor }
                    }
                },
                interaction: { mode: 'index', intersect: false },
                animation: { duration: 400, easing: 'easeOutQuart' }
            }
        });
    } catch (error) {
        console.error('Chyba při vytváření grafu:', error);
    }
}

function toggleDataset(datasetName) {
    datasetVisibility[datasetName] = !datasetVisibility[datasetName];
    if (mainChart) {
        const idx = datasetKeys.indexOf(datasetName);
        if (idx !== -1) {
            mainChart.setDatasetVisibility(idx, datasetVisibility[datasetName]);
            mainChart.update();
            return;
        }
    }
    createMainChart();
}

function toggleAllDatasets() {
    const allVisible = Object.values(datasetVisibility).every(v => v);
    const newState = !allVisible;
    
    Object.keys(datasetVisibility).forEach(key => {
        datasetVisibility[key] = newState;
        const checkbox = document.getElementById(`toggle-${key}`);
        if (checkbox) checkbox.checked = newState;
    });
    
    document.getElementById('toggle-all-text').textContent = newState ? 'Vypnout vše' : 'Zapnout vše';
    
    if (mainChart) {
        datasetKeys.forEach((key, idx) => mainChart.setDatasetVisibility(idx, newState));
        mainChart.update();
    } else {
        createMainChart();
    }
}

function toggleChartType() {
    chartType = chartType === 'bar' ? 'line' : 'bar';
    document.getElementById('chart-type-text').textContent = chartType === 'bar' ? 'Sloupcový graf' : 'Čárový graf';
    createMainChart();
}

function showNoDataMessage() {
    const chartsContainer = document.getElementById('charts-container');
    chartsContainer.innerHTML = `
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Žádná data k zobrazení</h3>
            <p class="text-gray-600">Nejsou k dispozici žádná data pro vytvoření grafů.</p>
        </div>
    `;
}


async function loadYoYData() {
    const container = document.getElementById('yoy-container');
    try {
        const res = await fetch('/api/grafy/yoy');
        const data = await res.json();
        const years = data.years || [];

        if (years.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Nedostatek dat pro meziroční porovnání.</p>';
            return;
        }

        const fmtNum = (v) => v.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const diffCell = (curr, prev, unit) => {
            if (prev === null || prev === undefined) return '';
            const diff = curr - prev;
            const pct = prev !== 0 ? ((diff / prev) * 100).toFixed(1) : '—';
            const color = diff <= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            const arrow = diff <= 0 ? '↓' : '↑';
            return `<span class="${color} text-xs font-medium">${arrow} ${fmtNum(Math.abs(diff))} ${escapeHtml(unit)} (${pct}%)</span>`;
        };

        let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Rok</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Měsíců</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">El. vysoký (kWh)</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">El. nízký (kWh)</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Plyn (m³)</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Voda (m³)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;

        years.forEach((y, i) => {
            const prev = i > 0 ? years[i - 1] : null;
            html += `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="px-4 py-3 text-sm font-bold text-gray-900 dark:text-white">${Number(y.year)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${Number(y.months_count)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex flex-col gap-0.5">
                            <span>${fmtNum(y.elektromer_vysoky)}</span>
                            ${prev ? diffCell(y.elektromer_vysoky, prev.elektromer_vysoky, 'kWh') : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex flex-col gap-0.5">
                            <span>${fmtNum(y.elektromer_nizky)}</span>
                            ${prev ? diffCell(y.elektromer_nizky, prev.elektromer_nizky, 'kWh') : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex flex-col gap-0.5">
                            <span>${fmtNum(y.plynomer)}</span>
                            ${prev ? diffCell(y.plynomer, prev.plynomer, 'm³') : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex flex-col gap-0.5">
                            <span>${fmtNum(y.vodomer)}</span>
                            ${prev ? diffCell(y.vodomer, prev.vodomer, 'm³') : ''}
                        </div>
                    </td>
                </tr>`;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = '<p class="text-center text-red-500 py-4">Chyba při načítání meziročního porovnání.</p>';
    }
}

// Funkce pro změnu časového období
function changePeriod(period) {
    currentPeriod = period;
    
    // Aktualizace vzhledu tlačítek (v pořadí: year, 2years, all)
    const buttons = ['year', '2years', 'all'];
    buttons.forEach(btn => {
        const button = document.getElementById(`period-${btn}`);
        if (btn === period) {
            button.className = 'inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-300 transition-colors';
        } else {
            button.className = 'inline-flex items-center px-4 py-2 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-300 transition-colors border border-gray-300';
        }
    });
    
    // Načtení nových dat
    loadChartData();
}
</script>
{% endblock %}
